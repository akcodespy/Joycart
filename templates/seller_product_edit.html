<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit Product</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="/static/css/main.css">

  <style>
    body {
      background: #f5f7fb;
    }

    .seller-header {
      background: #111827;
      color: #fff;
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .seller-header h1 {
      font-size: 20px;
      margin: 0;
    }

    .seller-header a {
      color: #e5e7eb;
      text-decoration: none;
      font-weight: 500;
    }

    .edit-container {
      max-width: 900px;
      margin: 32px auto;
      padding: 0 16px;
    }

    .edit-card {
      background: #ffffff;
      padding: 28px;
      border-radius: 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    }

    fieldset {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 20px;
    }

    legend {
      font-weight: 600;
      padding: 0 8px;
    }

    label {
      display: block;
      font-size: 14px;
      margin-bottom: 6px;
      font-weight: 500;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      margin-bottom: 16px;
    }

    textarea {
      resize: vertical;
    }

    .inline-inputs {
      display: flex;
      gap: 10px;
    }

    .inline-inputs input {
      flex: 1;
    }

    .preview-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .preview-row img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }

    .form-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 16px;
    }

    .form-actions button {
      background: #4f46e5;
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 15px;
      cursor: pointer;
    }

    .form-actions button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    #wait-text {
      font-size: 14px;
      color: #6b7280;
    }
  </style>
</head>

<body>

<header class="seller-header">
  <h1>Edit Product</h1>
  <a href="/seller/products">Your Products</a>
</header>

<main class="edit-container">
  <div class="edit-card">

    <h2>Update Product Details</h2>

    <form method="post"
          action="/seller/products/editfn/{{ product.id }}">

      
      <fieldset>
        <legend>Basic Product Information</legend>

        <label>Product Title</label>
        <input type="text" name="title" value="{{ product.title }}" required>

        <label>Description</label>
        <textarea name="description" rows="4" required>{{ product.description }}</textarea>

        <label>Category</label>
        <input type="text" name="category" value="{{ product.category }}" required>

        <label>SKU</label>
        <input type="text" name="sku" value="{{ product.sku }}" required>
      </fieldset>

      
      <fieldset>
        <legend>Pricing & Availability</legend>

        <label>Price</label>
        <input type="number" name="price" step="0.01" value="{{ product.price }}" required>

        <label>Discount Percentage</label>
        <input type="number" name="discountPercentage" step="0.01"
               value="{{ product.discountPercentage }}">

        <label>Stock Quantity</label>
        <input type="number" name="stock" min="0" value="{{ product.stock }}" required>

        <label>Availability Status</label>
        <select name="availabilityStatus">
          <option value="In Stock" {% if product.availabilityStatus == "In Stock" %}selected{% endif %}>In Stock</option>
          <option value="Low Stock" {% if product.availabilityStatus == "Low Stock" %}selected{% endif %}>Low Stock</option>
          <option value="Out of Stock" {% if product.availabilityStatus == "Out of Stock" %}selected{% endif %}>Out of Stock</option>
        </select>

        <label>Return Policy</label>
        <input type="text" name="returnPolicy" value="{{ product.returnPolicy }}">
      </fieldset>

      
      <fieldset>
        <legend>Physical Details (Optional)</legend>

        <label>Weight (grams)</label>
        <input type="number" name="weight" value="{{ product.weight }}">

        <label>Dimensions (cm)</label>
        <div class="inline-inputs">
          <input type="number" name="length" step="0.1"
                 placeholder="Length"
                 value="{{ product.dimensions.length if product.dimensions }}">
          <input type="number" name="width" step="0.1"
                 placeholder="Width"
                 value="{{ product.dimensions.width if product.dimensions }}">
          <input type="number" name="height" step="0.1"
                 placeholder="Height"
                 value="{{ product.dimensions.height if product.dimensions }}">
        </div>

        <label>Shipping Information</label>
        <input type="text" name="shippingInformation"
               value="{{ product.shippingInformation }}">

        <label>Warranty Information</label>
        <input type="text" name="warrantyInformation"
               value="{{ product.warrantyInformation }}">
      </fieldset>

      
      <fieldset>
        <legend>Product Images</legend>

        <label>Current Thumbnail</label>
            <div class="preview-row">
        <img id="currentThumbnail" src="{{ product.thumbnail }}">
      </div>

        <label>Replace Thumbnail</label>
        <input type="file" id="thumbnailInput" accept="image/*">
        <input type="hidden" name="thumbnail" id="thumbnailUrl">

        <label>Current Images</label>
        <div class="preview-row">
          {% for img in product.images %}
            <img src="{{ img }}">
          {% endfor %}
        </div>

        <label>Replace Images</label>
        <input type="file" id="imagesInput" accept="image/*" multiple>
        <input type="hidden" name="images" id="imagesUrls">
      </fieldset>

      
      <div class="form-actions">
        <button type="submit" id="submit-btn">Update Product</button>
      </div>

    </form>
  </div>
</main>

<script>

const form = document.querySelector("form");

form.addEventListener("submit", function (e) {
  const thumbChanged = document.getElementById("thumbnailInput").files.length > 0;
  const imgsChanged = document.getElementById("imagesInput").files.length > 0;

  if ((thumbChanged && !thumbnailUrl.value) ||
      (imgsChanged && !imagesUrls.value)) {
    e.preventDefault();
    alert("Please wait until image upload finishes");
  }
});


async function getSignature(folder) {
  const res = await fetch(`/cloudinary/sign?folder=${folder}`);
  return res.json();
}

async function uploadFile(file, folder) {
  const sig = await getSignature(folder);
  const fd = new FormData();
  fd.append("file", file);
  fd.append("api_key", sig.api_key);
  fd.append("timestamp", sig.timestamp);
  fd.append("signature", sig.signature);
  fd.append("folder", sig.folder);

  const res = await fetch(
    `https://api.cloudinary.com/v1_1/${sig.cloud_name}/image/upload`,
    { method: "POST", body: fd }
  );
  return res.json();
}


document.getElementById("thumbnailInput").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  const preview = document.getElementById("currentThumbnail");
  preview.src = URL.createObjectURL(file);

  document.getElementById("wait-text").style.display = "inline";
  const data = await uploadFile(file, "products/thumbnails");
  if (!data.secure_url) {
      console.error("Thumbnail upload failed:", data);
      alert("Thumbnail upload failed. Check console.");
      return;
    }
  document.getElementById("thumbnailUrl").value = data.secure_url;
});


document.getElementById("imagesInput").addEventListener("change", async e => {
  document.getElementById("wait-text").style.display = "inline";
  const urls = [];
  for (const file of e.target.files) {
    const data = await uploadFile(file, "products/images");
    if (!data.secure_url) {
  console.error("Image upload failed:", data);
  alert("One image failed to upload. Check console.");
  continue;
}
    
    urls.push(data.secure_url);
  }
  document.getElementById("imagesUrls").value = JSON.stringify(urls);
});


document.querySelector("form").addEventListener("submit", function () {
  document.getElementById("submit-btn").disabled = true;
  document.getElementById("submit-btn").innerText = "Please wait...";
});
</script>

</body>
</html>
