<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Product</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="/static/css/main.css">

  <style>
    body {
      background: #f5f7fb;
    }

    
    .seller-header {
      background: #111827;
      color: #fff;
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .seller-header a {
      color: #e5e7eb;
      text-decoration: none;
      font-weight: 500;
    }

    
    .seller-form-container {
      max-width: 900px;
      margin: 32px auto;
      padding: 0 16px;
    }

    .form-card {
      background: #fff;
      border-radius: 14px;
      padding: 28px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      margin-bottom: 24px;
    }

    .form-card h3 {
      margin-top: 0;
      margin-bottom: 16px;
      font-size: 18px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    label {
      font-size: 14px;
      color: #374151;
      display: block;
    }

    input,
    textarea,
    select {
      width: 100%;
      margin-top: 6px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    textarea {
      resize: vertical;
    }

    .preview-row {
      display: flex;
      gap: 12px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .preview-row img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }

    .form-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .submit-btn {
      padding: 12px 26px;
      border-radius: 10px;
      background: #4f46e5;
      color: #fff;
      font-weight: 600;
      border: none;
      cursor: pointer;
    }

    .submit-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .wait-text {
      color: #6b7280;
      font-size: 14px;
    }
  </style>
</head>

<body>

<header class="seller-header">
  <h2>Add New Product</h2>
  <a href="/seller/dashboard">Dashboard</a>
</header>

<main class="seller-form-container">

<form method="post" action="/seller/product/create">

  
  <div class="form-card">
    <h3>Basic Product Information</h3>

    <div class="form-grid">
      <label>Product Title
        <input type="text" name="title" required>
      </label>

      <label>Category
        <input type="text" name="category" required>
      </label>

      <label>SKU
        <input type="text" name="sku" required>
      </label>
    </div>

    <label style="margin-top:16px;">
      Description
      <textarea name="description" rows="4" required></textarea>
    </label>
  </div>

  
  <div class="form-card">
    <h3>Pricing & Availability</h3>

    <div class="form-grid">
      <label>Price
        <input type="number" name="price" step="0.01" required>
      </label>

      <label>Discount %
        <input type="number" name="discountPercentage" step="0.01" value="0" required>
      </label>

      <label>Stock
        <input type="number" name="stock" min="0" required>
      </label>

      <label>Availability
        <select name="availabilityStatus">
          <option value="In Stock">In Stock</option>
          <option value="Low Stock">Low Stock</option>
          <option value="Out of Stock">Out of Stock</option>
        </select>
      </label>

      <label>Return Policy
        <input type="text" name="returnPolicy" required>
      </label>
    </div>
  </div>

  
  <div class="form-card">
    <h3>Physical & Shipping Details</h3>

    <div class="form-grid">
      <label>Weight (grams)
        <input type="number" name="weight">
      </label>

      <label>Length (cm)
        <input type="number" name="length" step="0.1">
      </label>

      <label>Width (cm)
        <input type="number" name="width" step="0.1">
      </label>

      <label>Height (cm)
        <input type="number" name="height" step="0.1">
      </label>

      <label>Shipping Info
        <input type="text" name="shippingInformation" required>
      </label>

      <label>Warranty Info
        <input type="text" name="warrantyInformation" required>
      </label>
    </div>
  </div>

  
  <div class="form-card">
    <h3>Product Images</h3>

    <label>
      Thumbnail
      <input type="file" id="thumbnailInput" accept="image/*" >
      <input type="hidden" name="thumbnail" id="thumbnailUrl">
    </label>
    <div class="preview-row">
      <img id="thumbnailPreview" style="display:none;">
    </div>

    <br>

    <label>
      Additional Images
      <input type="file" id="imagesInput" accept="image/*" multiple>
      <input type="hidden" name="images" id="imagesUrls">
    </label>
    <div id="imagesPreview" class="preview-row"></div>
  </div>

  
  <div class="form-card">
    <div class="form-actions">
      <button type="submit" id="submitBtn" class="submit-btn" disabled>
        Add Product
      </button>
    </div>
  </div>

</form>
</main>

<script>

let uploadedThumbnailUrl = null;

async function getSignature(folder) {
  const res = await fetch(`/cloudinary/sign?folder=${folder}`);
  return res.json();
}

async function uploadFile(file, folder) {
  const sig = await getSignature(folder);
  const fd = new FormData();
  fd.append("file", file);
  fd.append("api_key", sig.api_key);
  fd.append("timestamp", sig.timestamp);
  fd.append("signature", sig.signature);
  fd.append("folder", sig.folder);

  const res = await fetch(
    `https://api.cloudinary.com/v1_1/${sig.cloud_name}/image/upload`,
    { method: "POST", body: fd }
  );
  return res.json();
}

let thumbDone = false;
let imagesDone = false;

function checkReady() {
  if (thumbDone && imagesDone) {
    document.getElementById("submitBtn").disabled = false;
    document.getElementById("waitText").style.display = "none";
  }
}

/* THUMBNAIL */
document.getElementById("thumbnailInput")
  .addEventListener("change", async (e) => {

    const file = e.target.files[0];
    if (!file) return;

    const img = document.getElementById("thumbnailPreview");

    // ✅ 1. INSTANT local preview (PUT IT HERE)
    img.src = URL.createObjectURL(file);
    img.style.display = "block";

    // ✅ 2. THEN upload to Cloudinary
    const data = await uploadFile(file, "products/thumbnails");

    // ✅ 3. SAVE FINAL URL
    if (!data.secure_url) {
      console.error("Thumbnail upload failed:", data);
      alert("Thumbnail upload failed. Check console.");
      return;
    }

    img.src = data.secure_url;
    document.getElementById("thumbnailUrl").value = data.secure_url;

    uploadedThumbnailUrl = data.secure_url;


    thumbDone = true;
    checkReady();
});

/* MULTIPLE IMAGES */
document.getElementById("imagesInput")
  .addEventListener("change", async (e) => {

    const preview = document.getElementById("imagesPreview");
    preview.innerHTML = "";

    const urls = [];

    if (uploadedThumbnailUrl) {
  urls.push(uploadedThumbnailUrl);
}

    for (const file of e.target.files) {

      // ✅ 1. instant preview
      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);
      preview.appendChild(img);

      // ✅ 2. upload
      const data = await uploadFile(file, "products/images");

      // ✅ 3. replace with Cloudinary URL
      img.src = data.secure_url;
      if (!data.secure_url) {
  console.error("Image upload failed:", data);
  alert("One image failed to upload. Check console.");
  continue;
}


      if (!urls.includes(data.secure_url)) {
  urls.push(data.secure_url);
}
    }

    // ✅ 4. save all URLs
    document.getElementById("imagesUrls").value = JSON.stringify(urls);
    imagesDone = true;
    checkReady();
});
</script>

</body>
</html>
